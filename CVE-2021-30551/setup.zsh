#!/bin/zsh

# get chromium
mkdir ~/chromium
cp dcheck.diff ~/chromium
git clone https://chromium.googlesource.com/chromium/src.git ~/chromium/src --branch 91.0.4472.100 --depth 1

# install depot_tools
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ~/depot_tools
cd ~/depot_tools
git checkout 1cabb17575917b73ec2e270d4187656c20b1ab0c # https://chromium.googlesource.com/chromium/src.git/+/refs/tags/91.0.4472.100/DEPS#971
echo "
export PATH=\$HOME/depot_tools:\$PATH
export DEPOT_TOOLS_UPDATE=0" >>~/.zshrc
source ~/.zshrc

# sync submodules
cd ~/chromium
echo 'solutions = [
  {
    "name": "src",
    "url": "https://chromium.googlesource.com/chromium/src.git",
    "managed": False,
    "custom_vars": { "checkout_configuration": "small" }
  }
]
target_os = ["unix"]
target_os_only = True
target_cpu = ["x64"]
target_cpu_only = True' >.gclient
gclient sync -Dvvv

# install gdb plugin
echo "
source $HOME/chromium/src/tools/gdb/gdbinit
source $HOME/chromium/src/v8/tools/gdbinit" >>~/.gdbinit

# install dependencies
cd src
./build/install-build-deps.sh

# build chromium
gn gen out/release --args='target_os="linux" target_cpu="x64" is_debug=false'
autoninja -C out/release chrome
pushd v8
git apply ../../dcheck.diff
popd
gn gen out/debug --args='target_os="linux" target_cpu="x64" is_component_build=false forbid_non_component_debug_builds=false v8_optimized_debug=false'
autoninja -C out/debug chrome

# wabt
git clone --recursive https://github.com/WebAssembly/wabt ~/wabt
cd ~/wabt
git submodule update --init
mkdir build
cd build
cmake ..
cmake --build .
