#!/bin/zsh

mkdir ~/v8
cp dcheck.diff ~/v8

# install depot_tools
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ~/depot_tools
cd ~/depot_tools
git checkout 94f76acc946d49ca95096cfe550fbdbfc1bac6c1 # https://chromium.googlesource.com/v8/v8/+/7f22404388ef0eb9383f189c1b0a85b5ea93b079/DEPS#238
echo "
export PATH=\$HOME/depot_tools:\$PATH
export DEPOT_TOOLS_UPDATE=0" >>~/.zshrc
source ~/.zshrc

# get v8 and submodules
cd ~/v8
echo 'solutions = [
  {
    "name": "v8",
    "url": "https://chromium.googlesource.com/v8/v8.git@7f22404388ef0eb9383f189c1b0a85b5ea93b079",
    "managed": True
  }
]
target_os = ["unix"]
target_os_only = True
target_cpu = ["x64"]
target_cpu_only = True' >.gclient
gclient sync -Dvvv --no-history

# install gdb plugin
echo "
source $HOME/v8/v8/tools/gdbinit" >>~/.gdbinit

# install dependencies
cd v8
./build/install-build-deps.sh

# build v8
git apply ../dcheck.diff
gn gen out/debug --args='target_os="linux" target_cpu="x64" is_component_build=false v8_optimized_debug=false'
autoninja -C out/debug d8
